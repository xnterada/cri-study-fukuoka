# 第5回 アクセス権の管理

> ⚠️ **注意**  
> Windowsユーザーは[2回目以降の起動](https://github.com/xnterada/cri-study-fukuoka/blob/main/docs/linux/setup/win.md#2%E5%9B%9E%E7%9B%AE%E4%BB%A5%E9%99%8D%E3%81%AE%E8%B5%B7%E5%8B%95)に従い、WSLのターミナルを起動してから本ページの内容を進めてください。PowerShellやコマンドプロンプトではなく、WSLのターミナルを使用する必要があります。

## ファイルの権限管理

Linuxでは、ファイルやディレクトリに対してアクセス権（パーミッション）を設定することで、誰がそのファイルを読み取り、書き込み、実行できるかを制御できます。これにより、システムのセキュリティを保ち、重要なファイルが意図しない変更や削除から保護されます。

> 📝 **備考**  
> アクセス権の管理は、マルチユーザーOSであるLinuxにおいて非常に重要な機能です。適切な権限設定により、システムの安全性と安定性を確保できます。

## パーミッション

ファイルやディレクトリに設定されるアクセス権の種類です。Linuxでは各ファイルとディレクトリに対して、**読み取り（read）**、**書き込み（write）**、**実行（execute）**の3つの権限を設定できます。

### 3つの基本権限

### 読み取り権限（read: r）

- **ファイルの場合**: ファイルの内容を表示・参照することができます。
- **ディレクトリの場合**: ディレクトリ内のファイル一覧を表示することができます。

### 書き込み権限（write: w）

- **ファイルの場合**: ファイルの内容を変更・削除することができます。
- **ディレクトリの場合**: ディレクトリ内にファイルを作成・削除することができます。

### 実行権限（execute: x）

- **ファイルの場合**: ファイルをプログラムとして実行することができます。
- **ディレクトリの場合**: ディレクトリ内に移動（`cd`コマンド）することができます。

> ℹ️ **情報**  
> ディレクトリの実行権限は「通過権限」とも呼ばれ、そのディレクトリを通ってさらに深い階層にアクセスするために必要です。つまり、実行権限がないとそのディレクトリを経由して中のファイルやディレクトリにアクセスできません。

### パーミッションの表示

`ls -l`コマンドでファイルの詳細情報を表示すると、最初の10文字でファイルの種類とパーミッションが表示されます。

```bash
ls -l
```

```
total 16
drwxr-xr-x 2 xnter xnter 4096 Jan  2 12:38 dir1
drwxr-xr-x 2 xnter xnter 4096 Jan  2 12:51 dir2
drwxr-xr-x 2 xnter xnter 4096 Jan  2 12:51 dir3
-rw-r--r-- 1 xnter xnter   43 Jan  3 10:22 file12.txt
```

表示の読み方：

- **1文字目**: ファイル種別（`-`=通常ファイル、`d`=ディレクトリ、`l`=シンボリックリンクなど）
- **2-4文字目**: 所有者（user）の権限（rwx）
- **5-7文字目**: グループ（group）の権限（rwx）
- **8-10文字目**: その他（other）の権限（rwx）

例：`-rw-r--r--`の場合

- `-`: 通常のファイル
- `rw-`: 所有者は読み取り・書き込み可能、実行不可
- `r--`: グループは読み取りのみ可能
- `r--`: その他のユーザーは読み取りのみ可能

## ユーザーとグループ

Linuxのパーミッションシステムでは、アクセス権限を3つの対象に分けて管理します。

### 所有者（User/Owner）

ファイルやディレクトリを作成したユーザー、またはそのファイルの所有権を持つユーザーです。通常、所有者には最も広い権限が与えられることが多いですが、設定によって異なります。

### グループ（Group）

複数のユーザーを一つのまとまりとして管理する仕組みです。同じプロジェクトで作業する複数のユーザーを同じグループに所属させることで、ファイルの共有と権限管理を効率的に行えます。

### その他（Other）

所有者でもグループメンバーでもない、すべてのユーザーを指します。一般的には最も制限された権限が設定されます。

> 💡 **ヒント**  
> 現在のユーザー名は`whoami`コマンド、所属グループは`groups`コマンドで確認できます。

```bash
whoami
groups
```

## rootユーザー

Linuxシステムにおける、システム全体に対する完全な制御権限を持つ特別な管理者アカウントです。

### rootユーザーの特徴

- **UID（ユーザーID）が0**: Linuxシステムでは、UID 0が管理者を表す特別な識別子です。
- **パーミッション制限なし**: ファイルの所有者や権限設定に関係なく、すべてのファイルやディレクトリにアクセス・変更可能。
- **システム管理権限**: サービスの起動・停止、システム設定の変更、ソフトウェアのインストール、ユーザー管理などが可能。

### `sudo`コマンドを使用したコマンドの実行

一時的に他のユーザー（通常はroot）の権限でコマンドを実行するのが`sudo`コマンドです。管理者権限が必要な操作を実行するために使用されます。

（例）パッケージリストの更新（要パスワード）：

```bash
sudo apt update
```

### sudoの特徴

- **一時的な権限昇格**: 必要な時だけ管理者（root）の権限を使用
- **監査ログ**: すべての`sudo`実行が記録されるため、追跡が容易
- **パスワード認証**: 実行時にユーザーのパスワード入力が求められる（設定により異なる）

> ⚠️ **注意**  
> `sudo`は実質的にrootユーザーと同等の強力な権限を与えるため、実行するコマンドの内容を十分理解してから使用してください。誤った操作はシステムに重大な影響を与える可能性があります。

### `su`コマンドを使用したユーザーの切り替え

`su`コマンドは主にrootユーザーに切り替えるために使用されます。

rootユーザーに完全に切り替え（rootのパスワードが必要）：

```bash
su -
```

> 💡 **ヒント**  
> rootユーザーのパスワードを設定していない場合は`Ctrl+C`で操作を中断してください。

`sudo`を使用したrootに切り替え（要パスワード）：

```bash
sudo su -
```

次のプロンプトが出力されればrootユーザーでログイン完了：

```
root@DESKTOP-NBGO3I5:~#
```

rootからログアウトして元のユーザーに戻る：

```bash
exit
```

### セキュリティ上の注意点

- **直接ログイン禁止**: セキュリティ向上のため、多くのシステムではrootユーザーでの直接ログインを禁止している。
- **sudoの活用**: 日常作業では`sudo`を使用して、必要な時のみ管理者権限を使用する。
- **最小権限の原則**: rootの権限が必要な作業以外は、通常のユーザーアカウントで作業を行う。

## アクセス権に関連するコマンド

### chmod（change mode）

ファイルやディレクトリのパーミッション（アクセス権限）を変更するコマンドです。所有者またはroot権限を持つユーザーのみが実行できます。

### 数値表記での指定

パーミッションを3桁の8進数で指定する方法です。各桁はそれぞれ所有者、グループ、その他のユーザーの権限を表します。

権限の数値：

- **4**: 読み取り権限（r）
- **2**: 書き込み権限（w）
- **1**: 実行権限（x）

これらの数値を足し合わせて権限を表現します：

- **7** (4+2+1): rwx（読み取り・書き込み・実行すべて可能）
- **6** (4+2): rw-（読み取り・書き込み可能、実行不可）
- **5** (4+1): r-x（読み取り・実行可能、書き込み不可）
- **4**: r--（読み取りのみ可能）
- **0**: ---（すべて不可）

次の例は、chmodコマンドでパーミッションを設定する方法を示しています。

所有者：rwx、グループ：r-x、その他：r-x：

```bash
chmod 755 file12.txt
```

所有者：rw-、グループ：r--、その他：r--：

```bash
chmod 644 dir1
```

所有者：rw-、グループ：---、その他：---：

```bash
chmod 600 dir2
```

> 💡 **ヒント**  
> **数値表記での指定**のほかに、**記号表記での指定**もあります。`chmod g+w dir3`のように、数値ではなく記号で権限を変更できますが、本カリキュラムでは学習対象外とします。

### ディレクトリの再帰的な権限変更

ディレクトリとその中身をすべて再帰的に権限変更したい場合は、`-R`オプションを使用します。

まず、階層構造のディレクトリとその中にファイルを作成します。

```bash
mkdir -p dir4/dir5/dir6
touch dir4/dir5/file13.txt dir4/dir5/dir6/file14.txt
```

確認：

```bash
ls -lR dir4
```

ディレクトリ`dir4`とその中身すべての権限を`755`に変更：

```bash
chmod -R 755 dir4
```

再度確認：

```bash
ls -lR dir4
```

すべてのファイルとディレクトリの権限が`rwxr-xr-x`に変更されていることが確認できます。

> ⚠️ **注意**  
> `-R`オプションは強力ですが、意図しないファイルの権限まで変更してしまう可能性があるので実行前に十分に確認してください。

### chown（change owner）

ファイルやディレクトリの**所有者**や**所有グループ**を変更するコマンドです。通常はroot権限または`sudo`が必要です。

所有者をrootユーザーに変更：

```bash
sudo chown root file12.txt
```

所有者とグループを同時にrootに変更：

```bash
sudo chown root:root dir1
```

> 💡 **ヒント**  
> `chown`でもグループのみの変更は可能ですが、多くの場合は`chgrp`を使用します。本カリキュラムでは説明しませんが、グループのみを変更したい場合は`chgrp`を、所有者も含めて変更したい場合は`chown`を使用するとよいでしょう。

### ディレクトリの再帰的な所有者変更

ディレクトリとその中身をすべて再帰的に所有者変更したい場合は、`-R`オプションを使用します。

```bash
sudo chown -R root:root dir4
```

## おわりに

適切なアクセス権の管理は、Linuxシステムのセキュリティと安定性を保つために不可欠です。ファイルやディレクトリの権限を適切に設定し、安全なシステム運用を心がけましょう。

> 💡 **ヒント**  
> セキュリティを重視する場合は、必要最小限の権限を与える**最小権限の原則**に従いましょう。
